# 定投+做T策略代码说明文档

## 1. 概述

本策略是一个基于VeighNa框架的定投+做T策略，旨在通过定期投资和短线交易相结合的方式，在控制风险的同时追求稳健收益。

### 1.1 策略组成

- **定投部分**：定期投资，止盈减仓
- **做T部分**：根据技术指标进行加仓减仓

### 1.2 资金分配

- 总资金：50万元
- 定投资金：30万元（60%）
- 做T资金：20万元（40%）

## 2. 文件结构

```
quant-bigA/
├── strategies/
│   ├── __init__.py                    # 策略包初始化
│   ├── indicators.py                   # 技术指标计算模块
│   └── dca_trading_strategy.py        # 定投+做T策略实现
├── backtesting/
│   ├── __init__.py                    # 回测包初始化
│   └── dca_trading_backtest.py       # 回测引擎
└── results/                          # 回测结果目录
    ├── backtest_summary.csv            # 综合回测结果
    ├── backtest_summary.json           # 综合回测结果（JSON）
    └── [symbol]/                    # 各标的详细结果
        ├── strategy_params.json        # 策略参数
        ├── trades.csv                # 所有交易记录
        ├── dca_trades.csv           # 定投交易记录
        ├── t_trades.csv             # 做T交易记录
        ├── daily_nav.csv            # 每日净值
        └── results.json             # 回测结果
```

## 3. 核心模块说明

### 3.1 技术指标模块 (strategies/indicators.py)

#### 3.1.1 主要功能

计算MACD、成交量、ATR、估值等技术指标，并生成交易信号。

#### 3.1.2 核心函数

**calculate_macd()**
- 计算MACD指标（快线12、慢线26、信号线9）
- 计算MACD上下轨（20日滚动窗口的20%/80%分位数）

**calculate_volume_indicators()**
- 计算成交量均线（20日）
- 计算成交量比率
- 判断是否放量（超过均值1.5倍）
- 判断是否缩量（低于均值0.8倍）

**calculate_atr()**
- 计算ATR（平均真实波幅，14日）
- 计算ATR比率（相对于价格）

**check_chip_consolidation()**
- 检查筹码结构是否整理完毕
- 条件：ATR比率低于2% 且 成交量萎缩

**calculate_valuation_metrics()**
- 计算估值指标（使用价格百分位作为代理）
- 判断是否高估（超过80%分位数）
- 判断是否低估（低于20%分位数）

**get_trading_signals()**
- 生成交易信号
- 加仓信号：下跌放量、MACD下轨、筹码整理完毕
- 减仓信号：MACD上轨且放量下跌

### 3.2 定投+做T策略 (strategies/dca_trading_strategy.py)

#### 3.2.1 策略参数

```python
total_capital = 500000.0      # 总资金
dca_ratio = 0.6               # 定投资金比例
dca_amount_per_month = 5000.0   # 每月定投金额
t_amount_per_trade = 10000.0    # 每次做T金额
max_loss_ratio = 0.05          # 最大亏损比例（止损）
profit_target = 0.30           # 止盈目标
commission = 0.0003            # 手续费率
slippage = 0.001              # 滑点率
```

#### 3.2.2 定投逻辑

**买入条件**
- MACD下轨
- 每月第一个交易日
- 有足够资金

**卖出条件**
- 盈利超过30%
- 标的高估（价格超过80%分位数）
- 减仓一半

#### 3.2.3 做T逻辑

**加仓条件**（满足任意一个）
1. 下跌放量：价格下跌且成交量超过1.5倍均值
2. MACD下轨：MACD值低于下轨
3. 筹码结构整理完毕：ATR比率低于2%且成交量萎缩

**减仓条件**（满足任意一个）
1. MACD上轨且放量下跌：MACD值高于上轨、价格下跌、成交量放量
2. 加仓仓位亏损超过5%

**做T规则**
- 每次加仓一份金额（10000元）
- 只有当上一份加仓T出才继续加仓
- 止损后可以继续加仓

### 3.3 回测引擎 (backtesting/dca_trading_backtest.py)

#### 3.3.1 主要功能

运行策略回测，生成详细的交易记录和结果分析。

#### 3.3.2 核心函数

**BacktestEngine.run_backtest()**
- 运行单个标的的回测
- 获取数据、计算指标、执行策略
- 返回回测结果

**BacktestEngine.run_multiple_backtests()**
- 运行多个标的的回测
- 保存综合结果
- 生成对比表格

**run_etf_backtests()**
- 运行ETF回测
- 测试宽基指数ETF和红利低波100ETF

## 4. 回测结果

### 4.1 测试标的

| 代码 | 名称 | 类型 |
|------|------|------|
| 510300.SH | 沪深300ETF | 宽基指数 |
| 510500.SH | 中证500ETF | 宽基指数 |
| 159915.SZ | 创业板ETF | 宽基指数 |
| 512880.SH | 证券ETF | 行业ETF |
| 512690.SH | 酒ETF | 行业ETF |
| 159928.SZ | 消费ETF | 行业ETF |
| 512100.SH | 中证1000ETF | 宽基指数 |
| 512000.SH | 券商ETF | 行业ETF |
| 516160.SH | 新能源车ETF | 主题ETF |
| 515050.SH | 5GETF | 主题ETF |
| 159806.SZ | 新能源ETF | 主题ETF |
| 516970.SH | 红利低波ETF | 红利低波 |

### 4.2 回测结果汇总

| 标的 | 总收益率 | 年化收益率 | 最大回撤 | 夏普比率 | 最终资产 |
|------|---------|-----------|---------|---------|---------|
| 510300.SH | -0.70% | -0.14% | -12.38% | -0.03 | 496,478.93 |
| 510500.SH | 0.98% | 0.19% | -12.45% | 0.04 | 504,880.25 |
| 159915.SZ | -1.64% | -0.33% | -17.04% | -0.04 | 491,789.25 |
| 512880.SH | 14.50% | 2.75% | -18.95% | 0.28 | 572,516.71 |
| 512690.SH | 0.85% | 0.17% | -18.52% | 0.02 | 504,235.33 |
| 159928.SZ | -9.47% | -1.97% | -20.92% | -0.29 | 452,666.89 |
| 512100.SH | 0.73% | 0.15% | -18.52% | 0.02 | 503,655.19 |
| 512000.SH | 15.53% | 2.93% | -18.76% | 0.29 | 577,667.60 |
| 516160.SH | -7.90% | -2.08% | -14.46% | -0.46 | 460,519.77 |
| 515050.SH | 8.10% | 1.57% | -11.86% | 0.21 | 540,505.84 |
| 159806.SZ | -1.92% | -0.40% | -15.08% | -0.08 | 490,410.43 |
| 516970.SH | 0.02% | 0.00% | -8.49% | 0.00 | 500,079.73 |

### 4.3 结果分析

**表现最好的标的**
- 512000.SH（券商ETF）：总收益率15.53%，年化收益率2.93%
- 512880.SH（证券ETF）：总收益率14.50%，年化收益率2.75%

**表现最差的标的**
- 159928.SZ（消费ETF）：总收益率-9.47%，最大回撤-20.92%
- 516160.SH（新能源车ETF）：总收益率-7.90%

**风险控制**
- 大部分标的的最大回撤控制在-20%以内
- 红利低波ETF（516970.SH）最大回撤最小，为-8.49%

## 5. 使用方法

### 5.1 运行回测

```bash
# 运行所有ETF回测
PYTHONPATH=/Users/sigma/Documents/myproject/quant-bigA:$PYTHONPATH python3 backtesting/dca_trading_backtest.py
```

### 5.2 查看结果

回测结果保存在`./results/`目录下：
- `backtest_summary.csv`：综合回测结果
- `backtest_summary.json`：综合回测结果（JSON格式）
- `[symbol]/`：各标的的详细结果

### 5.3 自定义参数

修改`backtesting/dca_trading_backtest.py`中的策略参数：

```python
strategy = DcaTradingStrategy(
    total_capital=500000.0,      # 总资金
    dca_ratio=0.6,               # 定投资金比例
    dca_amount_per_month=5000.0,   # 每月定投金额
    t_amount_per_trade=10000.0,    # 每次做T金额
    max_loss_ratio=0.05,          # 最大亏损比例
    profit_target=0.30,           # 止盈目标
    commission=0.0003,            # 手续费率
    slippage=0.001               # 滑点率
)
```

## 6. 优化建议

### 6.1 策略优化

1. **动态调整定投金额**
   - 根据估值水平调整定投金额
   - 低估时增加定投金额，高估时减少定投金额

2. **优化做T信号**
   - 增加更多技术指标确认
   - 如RSI、KDJ等

3. **改进估值判断**
   - 使用真实的PE/PB数据
   - 考虑行业估值差异

4. **增加风险控制**
   - 设置最大持仓比例
   - 增加最大回撤限制
   - 实现动态止损

### 6.2 代码优化

1. **性能优化**
   - 使用向量化计算替代循环
   - 优化技术指标计算效率

2. **功能扩展**
   - 支持多个标的同时运行
   - 增加实时交易接口
   - 实现可视化分析

## 7. 注意事项

1. **数据要求**
   - 需要提前下载ETF历史数据
   - 数据路径：`./data/etfs/`

2. **回测限制**
   - 回测结果仅供参考，不构成投资建议
   - 实际交易中存在滑点、手续费等额外成本
   - 市场环境变化可能影响策略表现

3. **风险提示**
   - 投资有风险，入市需谨慎
   - 建议结合自身风险承受能力调整策略参数
   - 建议进行充分的历史回测和模拟交易

## 8. 版本信息

- 版本：1.0.0
- 开发日期：2026-01-18
- 框架：VeighNa
- Python版本：3.7+

## 9. 联系方式

如有问题或建议，请联系开发团队。

---

**免责声明**：本策略仅供学习研究使用，不构成投资建议。投资有风险，入市需谨慎。