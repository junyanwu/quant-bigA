{% extends "base.html" %}

{% block title %}仪表板 - A股量化交易系统{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h2>
            <i class="fas fa-tachometer-alt me-2"></i>
            系统仪表板
        </h2>
        <p class="text-muted">实时监控系统运行状态和关键指标</p>
    </div>
</div>

<!-- 系统状态卡片 -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card border-0 shadow-sm">
            <div class="card-body text-center">
                <div class="bg-primary text-white rounded-circle mx-auto mb-3" style="width: 80px; height: 80px; display: flex; align-items: center; justify-content: center;">
                    <i class="fas fa-database fa-2x"></i>
                </div>
                <h3 id="stocks-count">--</h3>
                <p class="text-muted mb-0">股票数据</p>
            </div>
        </div>
    </div>
    
    <div class="col-md-3">
        <div class="card border-0 shadow-sm">
            <div class="card-body text-center">
                <div class="bg-success text-white rounded-circle mx-auto mb-3" style="width: 80px; height: 80px; display: flex; align-items: center; justify-content: center;">
                    <i class="fas fa-chart-pie fa-2x"></i>
                </div>
                <h3 id="etfs-count">--</h3>
                <p class="text-muted mb-0">ETF数据</p>
            </div>
        </div>
    </div>
    
    <div class="col-md-3">
        <div class="card border-0 shadow-sm">
            <div class="card-body text-center">
                <div class="bg-info text-white rounded-circle mx-auto mb-3" style="width: 80px; height: 80px; display: flex; align-items: center; justify-content: center;">
                    <i class="fas fa-sync-alt fa-2x"></i>
                </div>
                <h3 id="last-update">--</h3>
                <p class="text-muted mb-0">最后更新</p>
            </div>
        </div>
    </div>
    
    <div class="col-md-3">
        <div class="card border-0 shadow-sm">
            <div class="card-body text-center">
                <div class="bg-warning text-white rounded-circle mx-auto mb-3" style="width: 80px; height: 80px; display: flex; align-items: center; justify-content: center;">
                    <i class="fas fa-network-wired fa-2x"></i>
                </div>
                <h3 id="connection-status">--</h3>
                <p class="text-muted mb-0">连接状态</p>
            </div>
        </div>
    </div>
</div>

<!-- 系统监控 -->
<div class="row">
    <div class="col-lg-8 mb-4">
        <div class="card">
            <div class="card-header bg-light">
                <h5 class="card-title mb-0">
                    <i class="fas fa-chart-line me-2"></i>
                    系统性能监控
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <canvas id="cpuChart" width="400" height="200"></canvas>
                    </div>
                    <div class="col-md-6">
                        <canvas id="memoryChart" width="400" height="200"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-lg-4 mb-4">
        <div class="card">
            <div class="card-header bg-light">
                <h5 class="card-title mb-0">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    系统告警
                </h5>
            </div>
            <div class="card-body">
                <div id="alertsList">
                    <div class="alert alert-success">
                        <i class="fas fa-check-circle me-2"></i>
                        系统运行正常
                    </div>
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        数据更新建议：建议每周更新一次
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 快速操作 -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header bg-light">
                <h5 class="card-title mb-0">
                    <i class="fas fa-bolt me-2"></i>
                    快速操作
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-2 text-center mb-3">
                        <button class="btn btn-outline-primary w-100" onclick="startDataDownload()">
                            <i class="fas fa-cloud-download-alt me-2"></i>下载数据
                        </button>
                    </div>
                    <div class="col-md-2 text-center mb-3">
                        <a href="/dca_backtest" class="btn btn-outline-success w-100">
                            <i class="fas fa-play me-2"></i>定投回测
                        </a>
                    </div>
                    <div class="col-md-2 text-center mb-3">
                        <a href="/strategy_backtest" class="btn btn-outline-warning w-100">
                            <i class="fas fa-cogs me-2"></i>策略测试
                        </a>
                    </div>
                    <div class="col-md-2 text-center mb-3">
                        <a href="/data_management" class="btn btn-outline-info w-100">
                            <i class="fas fa-database me-2"></i>数据管理
                        </a>
                    </div>
                    <div class="col-md-2 text-center mb-3">
                        <a href="/realtime_monitor" class="btn btn-outline-secondary w-100">
                            <i class="fas fa-eye me-2"></i>实时监控
                        </a>
                    </div>
                    <div class="col-md-2 text-center mb-3">
                        <button class="btn btn-outline-dark w-100" onclick="refreshDashboard()">
                            <i class="fas fa-sync-alt me-2"></i>刷新
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let cpuChart = null;
let memoryChart = null;

// 页面加载完成后执行
$(document).ready(function() {
    // 获取系统信息
    fetch('/api/system_info')
        .then(response => response.json())
        .then(data => {
            $('#stocks-count').text(data.stocks_count);
            $('#etfs-count').text(data.etfs_count);
            $('#last-update').text(data.last_update);
            $('#connection-status').html('<span class="badge bg-success">在线</span>');
        });
    
    // 初始化监控图表
    initializeMonitoringCharts();
    
    // 设置定时刷新
    setInterval(refreshDashboard, 30000); // 30秒刷新一次
});

// 初始化监控图表
function initializeMonitoringCharts() {
    // CPU使用率图表
    const cpuCtx = document.getElementById('cpuChart').getContext('2d');
    cpuChart = new Chart(cpuCtx, {
        type: 'line',
        data: {
            labels: Array.from({length: 10}, (_, i) => i + 1),
            datasets: [{
                label: 'CPU使用率 (%)',
                data: [25, 30, 28, 35, 40, 38, 42, 45, 43, 40],
                borderColor: 'rgb(75, 192, 192)',
                tension: 0.1,
                fill: false
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: { display: false }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    max: 100
                }
            }
        }
    });
    
    // 内存使用率图表
    const memoryCtx = document.getElementById('memoryChart').getContext('2d');
    memoryChart = new Chart(memoryCtx, {
        type: 'line',
        data: {
            labels: Array.from({length: 10}, (_, i) => i + 1),
            datasets: [{
                label: '内存使用率 (%)',
                data: [60, 62, 65, 63, 68, 70, 72, 75, 73, 70],
                borderColor: 'rgb(255, 99, 132)',
                tension: 0.1,
                fill: false
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: { display: false }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    max: 100
                }
            }
        }
    });
}

// 刷新仪表板
function refreshDashboard() {
    fetch('/api/system_info')
        .then(response => response.json())
        .then(data => {
            $('#stocks-count').text(data.stocks_count);
            $('#etfs-count').text(data.etfs_count);
            $('#last-update').text(data.last_update);
        });
    
    // 更新图表数据（模拟）
    if (cpuChart && memoryChart) {
        const newCpuValue = Math.random() * 30 + 20;
        const newMemoryValue = Math.random() * 20 + 60;
        
        cpuChart.data.datasets[0].data.push(newCpuValue);
        cpuChart.data.datasets[0].data.shift();
        cpuChart.update();
        
        memoryChart.data.datasets[0].data.push(newMemoryValue);
        memoryChart.data.datasets[0].data.shift();
        memoryChart.update();
    }
    
    showNotification('仪表板已刷新', 'info');
}

// 开始数据下载
function startDataDownload() {
    $('#downloadModal').modal('show');
    
    fetch('/api/start_download', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        }
    });
}
</script>
{% endblock %}