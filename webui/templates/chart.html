<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kçº¿å›¾ - Aè‚¡é‡åŒ–äº¤æ˜“ç³»ç»Ÿ</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <style>
        .chart-container {
            height: 600px;
            margin: 20px 0;
        }
        .symbol-selector {
            margin: 20px 0;
        }
        .data-info {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="/">Aè‚¡é‡åŒ–äº¤æ˜“ç³»ç»Ÿ</a>
            <div class="navbar-nav">
                <a class="nav-link" href="/">é¦–é¡µ</a>
                <a class="nav-link active" href="/chart">Kçº¿å›¾</a>
                <a class="nav-link" href="/data_management">æ•°æ®ç®¡ç†</a>
                <a class="nav-link" href="/backtest">å›æµ‹åˆ†æ</a>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <h2>ğŸ“ˆ Kçº¿å›¾åˆ†æ</h2>
        
        <div class="row">
            <div class="col-md-4">
                <div class="symbol-selector">
                    <label for="symbolType" class="form-label">æ ‡çš„ç±»å‹</label>
                    <select class="form-select" id="symbolType">
                        <option value="stock">è‚¡ç¥¨</option>
                        <option value="etf">ETF</option>
                        <option value="index">æŒ‡æ•°</option>
                    </select>
                    
                    <label for="symbolSelect" class="form-label mt-3">é€‰æ‹©æ ‡çš„</label>
                    <select class="form-select" id="symbolSelect">
                        <option value="">è¯·é€‰æ‹©...</option>
                    </select>
                    
                    <label for="periodSelect" class="form-label mt-3">æ—¶é—´å‘¨æœŸ</label>
                    <select class="form-select" id="periodSelect">
                        <option value="1M">1ä¸ªæœˆ</option>
                        <option value="3M">3ä¸ªæœˆ</option>
                        <option value="6M" selected>6ä¸ªæœˆ</option>
                        <option value="1Y">1å¹´</option>
                        <option value="2Y">2å¹´</option>
                        <option value="ALL">å…¨éƒ¨æ•°æ®</option>
                    </select>
                    
                    <button class="btn btn-primary mt-3 w-100" onclick="loadChart()">åŠ è½½å›¾è¡¨</button>
                </div>
                
                <div class="data-info" id="dataInfo">
                    <h5>æ•°æ®ä¿¡æ¯</h5>
                    <p>è¯·é€‰æ‹©æ ‡çš„åŠ è½½æ•°æ®</p>
                </div>
            </div>
            
            <div class="col-md-8">
                <div class="chart-container" id="klineChart"></div>
            </div>
        </div>
    </div>

    <script>
        let chart = null;
        let availableSymbols = {
            stock: [],
            etf: [],
            index: []
        };

        // åˆå§‹åŒ–å›¾è¡¨
        function initChart() {
            const chartDom = document.getElementById('klineChart');
            chart = echarts.init(chartDom);
            
            // çª—å£å¤§å°å˜åŒ–æ—¶é‡ç»˜å›¾è¡¨
            window.addEventListener('resize', function() {
                chart.resize();
            });
        }

        // åŠ è½½å¯ç”¨æ ‡çš„åˆ—è¡¨
        function loadSymbols() {
            fetch('/api/symbols')
                .then(response => response.json())
                .then(data => {
                    availableSymbols = data;
                    updateSymbolSelect();
                })
                .catch(error => console.error('åŠ è½½æ ‡çš„åˆ—è¡¨å¤±è´¥:', error));
        }

        // æ›´æ–°æ ‡çš„é€‰æ‹©å™¨
        function updateSymbolSelect() {
            const symbolType = document.getElementById('symbolType').value;
            const symbolSelect = document.getElementById('symbolSelect');
            
            // æ¸…ç©ºé€‰é¡¹
            symbolSelect.innerHTML = '<option value="">è¯·é€‰æ‹©...</option>';
            
            // æ·»åŠ æ–°é€‰é¡¹
            const symbols = availableSymbols[symbolType] || [];
            symbols.forEach(symbol => {
                const option = document.createElement('option');
                option.value = symbol;
                option.textContent = symbol;
                symbolSelect.appendChild(option);
            });
        }

        // åŠ è½½Kçº¿å›¾æ•°æ®
        function loadChart() {
            const symbolType = document.getElementById('symbolType').value;
            const symbol = document.getElementById('symbolSelect').value;
            const period = document.getElementById('periodSelect').value;
            
            if (!symbol) {
                alert('è¯·é€‰æ‹©æ ‡çš„');
                return;
            }
            
            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            chart.showLoading();
            
            fetch(`/api/chart_data?symbol=${symbol}&type=${symbolType}&period=${period}`)
                .then(response => response.json())
                .then(data => {
                    chart.hideLoading();
                    if (data.success) {
                        renderKLineChart(data.data, symbol);
                        updateDataInfo(data.info);
                    } else {
                        alert('åŠ è½½æ•°æ®å¤±è´¥: ' + data.message);
                    }
                })
                .catch(error => {
                    chart.hideLoading();
                    console.error('åŠ è½½å›¾è¡¨æ•°æ®å¤±è´¥:', error);
                    alert('åŠ è½½æ•°æ®å¤±è´¥');
                });
        }

        // æ¸²æŸ“Kçº¿å›¾
        function renderKLineChart(data, symbol) {
            const dates = data.map(item => item.date);
            const values = data.map(item => [
                item.open,
                item.close,
                item.low,
                item.high
            ]);
            
            const option = {
                title: {
                    text: symbol + ' Kçº¿å›¾',
                    left: 'center'
                },
                tooltip: {
                    trigger: 'axis',
                    axisPointer: {
                        type: 'cross'
                    },
                    formatter: function (params) {
                        const data = params[0].data;
                        return `
                            <div>æ—¥æœŸ: ${params[0].axisValue}</div>
                            <div>å¼€ç›˜: ${data[1]}</div>
                            <div>æ”¶ç›˜: ${data[2]}</div>
                            <div>æœ€ä½: ${data[3]}</div>
                            <div>æœ€é«˜: ${data[4]}</div>
                        `;
                    }
                },
                grid: {
                    left: '10%',
                    right: '10%',
                    bottom: '15%'
                },
                xAxis: {
                    type: 'category',
                    data: dates,
                    scale: true,
                    boundaryGap: false,
                    axisLine: { onZero: false },
                    splitLine: { show: false },
                    splitNumber: 20,
                    min: 'dataMin',
                    max: 'dataMax'
                },
                yAxis: {
                    scale: true,
                    splitArea: {
                        show: true
                    }
                },
                dataZoom: [
                    {
                        type: 'inside',
                        start: 50,
                        end: 100
                    },
                    {
                        show: true,
                        type: 'slider',
                        top: '90%',
                        start: 50,
                        end: 100
                    }
                ],
                series: [
                    {
                        name: symbol,
                        type: 'candlestick',
                        data: values,
                        itemStyle: {
                            color: '#ec0000',
                            color0: '#00da3c',
                            borderColor: '#8A0000',
                            borderColor0: '#008F28'
                        }
                    }
                ]
            };
            
            chart.setOption(option);
        }

        // æ›´æ–°æ•°æ®ä¿¡æ¯
        function updateDataInfo(info) {
            const dataInfo = document.getElementById('dataInfo');
            dataInfo.innerHTML = `
                <h5>æ•°æ®ä¿¡æ¯</h5>
                <p><strong>æ ‡çš„:</strong> ${info.symbol}</p>
                <p><strong>æ•°æ®æ¡æ•°:</strong> ${info.count} æ¡</p>
                <p><strong>æ—¶é—´èŒƒå›´:</strong> ${info.start_date} è‡³ ${info.end_date}</p>
                <p><strong>æœ€æ–°ä»·æ ¼:</strong> ${info.last_price}</p>
                <p><strong>æ¶¨è·Œå¹…:</strong> <span style="color: ${info.change_percent >= 0 ? 'red' : 'green'}">${info.change_percent}%</span></p>
            `;
        }

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            initChart();
            loadSymbols();
            
            // ç›‘å¬æ ‡çš„ç±»å‹å˜åŒ–
            document.getElementById('symbolType').addEventListener('change', updateSymbolSelect);
        });
    </script>
</body>
</html>