<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>定投+做T策略可视化</title>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            background-color: #f5f5f5;
            color: #333;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        .header h1 {
            margin: 0;
            font-size: 28px;
            font-weight: bold;
        }
        
        .header p {
            margin: 10px 0 0 0;
            font-size: 14px;
            opacity: 0.9;
        }
        
        .selector-section {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .selector-section h2 {
            margin: 0 0 15px 0;
            font-size: 18px;
            color: #667eea;
        }
        
        .search-box {
            margin-bottom: 15px;
        }
        
        .search-box input {
            width: 100%;
            padding: 10px 15px;
            border: 1px solid #e9ecef;
            border-radius: 6px;
            font-size: 14px;
            box-sizing: border-box;
        }
        
        .search-box input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .strategies-section {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .strategies-section h2 {
            margin: 0 0 15px 0;
            font-size: 18px;
            color: #667eea;
        }
        
        .strategies-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 15px;
        }
        
        .strategy-card {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .strategy-card:hover {
            background: #f0f4ff;
            border-color: #667eea;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        
        .strategy-card.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }
        
        .strategy-card h3 {
            margin: 0 0 10px 0;
            font-size: 16px;
            font-weight: bold;
        }
        
        .strategy-card p {
            margin: 0 0 10px 0;
            font-size: 13px;
            opacity: 0.8;
        }
        
        .strategy-card .version {
            font-size: 12px;
            opacity: 0.6;
        }
        
        .strategy-detail-section {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            display: none;
        }
        
        .strategy-detail-section.active {
            display: block;
        }
        
        .strategy-detail-section h2 {
            margin: 0 0 15px 0;
            font-size: 18px;
            color: #667eea;
        }
        
        .strategy-detail-content {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 15px;
        }
        
        .strategy-detail-item {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 15px;
        }
        
        .strategy-detail-item h3 {
            margin: 0 0 10px 0;
            font-size: 14px;
            color: #333;
        }
        
        .strategy-detail-item p {
            margin: 0;
            font-size: 13px;
            color: #666;
            line-height: 1.5;
        }
        
        .strategy-detail-item ul {
            margin: 0;
            padding-left: 20px;
            font-size: 13px;
            color: #666;
        }
        
        .strategy-detail-item li {
            margin: 5px 0;
        }
        
        .symbol-list {
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            margin-top: 15px;
        }
        
        .symbol-list::-webkit-scrollbar {
            width: 8px;
        }
        
        .symbol-list::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        
        .symbol-list::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }
        
        .symbol-list::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        
        .symbol-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 15px;
            border-bottom: 1px solid #e9ecef;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .symbol-item:hover {
            background: #f0f4ff;
        }
        
        .symbol-item.active {
            background: #667eea;
            color: white;
        }
        
        .symbol-item .symbol-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .symbol-item .symbol-code {
            font-size: 14px;
            font-weight: bold;
        }
        
        .symbol-item .symbol-name {
            font-size: 13px;
            color: #666;
        }
        
        .symbol-item.active .symbol-name {
            color: white;
        }
        
        .symbol-item .symbol-type {
            font-size: 11px;
            padding: 2px 6px;
            border-radius: 3px;
            background: #e9ecef;
            color: #666;
        }
        
        .symbol-item.active .symbol-type {
            background: rgba(255,255,255,0.2);
            color: white;
        }
        
        .symbol-card.active .symbol-name {
            color: white;
        }
        
        .chart-section {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .chart-section h2 {
            margin: 0 0 15px 0;
            font-size: 18px;
            color: #667eea;
        }
        
        .chart-container {
            width: 100%;
            height: 500px;
            margin-top: 15px;
        }
        
        .indicators-section {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .indicators-section h2 {
            margin: 0 0 15px 0;
            font-size: 18px;
            color: #667eea;
        }
        
        .indicators-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 15px;
        }
        
        .indicator-card {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 15px;
        }
        
        .indicator-card h3 {
            margin: 0 0 10px 0;
            font-size: 14px;
            color: #333;
        }
        
        .indicator-value {
            font-size: 24px;
            font-weight: bold;
            color: #667eea;
        }
        
        .indicator-label {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
        }
        
        .results-section {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .results-section h2 {
            margin: 0 0 15px 0;
            font-size: 18px;
            color: #667eea;
        }
        
        .results-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        
        .results-table th {
            background: #667eea;
            color: white;
            padding: 12px;
            text-align: left;
            font-weight: bold;
        }
        
        .results-table td {
            padding: 12px;
            border-bottom: 1px solid #e9ecef;
        }
        
        .results-table tr:hover {
            background: #f8f9fa;
        }
        
        .type-tag {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: bold;
            margin-right: 8px;
            margin-bottom: 4px;
        }
        
        .filter-buttons {
            margin-bottom: 15px;
            display: flex;
            gap: 10px;
        }
        
        .filter-btn {
            padding: 8px 20px;
            border: none;
            border-radius: 6px;
            background: #e9ecef;
            color: #666;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s;
        }
        
        .filter-btn:hover {
            background: #dee2e6;
            color: #667eea;
        }
        
        .filter-btn.active {
            background: #667eea;
            color: white;
        }
        
        .positive {
            color: #10b981;
            font-weight: bold;
        }
        
        .negative {
            color: #ef4444;
            font-weight: bold;
        }
        
        .legend {
            display: flex;
            gap: 20px;
            margin-top: 15px;
            justify-content: center;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
        }
        
        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 4px;
        }
        
        .loading {
            text-align: center;
            padding: 50px;
            font-size: 18px;
            color: #667eea;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>定投+做T策略可视化</h1>
            <p>基于VeighNa框架的定投+做T策略回测结果展示</p>
        </div>
        
        <div id="symbolsData" style="display: none;">{{ symbols|tojson }}</div>
        
        <div class="strategies-section">
            <h2>策略列表</h2>
            <div class="strategies-grid" id="strategiesGrid">
            </div>
        </div>
        
        <div class="strategy-detail-section" id="strategyDetailSection">
            <h2>策略详情</h2>
            <div class="strategy-detail-content" id="strategyDetailContent">
            </div>
        </div>
        
        <div class="results-section">
            <h2>回测结果</h2>
            <div class="filter-buttons">
                <button class="filter-btn active" onclick="filterResults('all')">全部</button>
                <button class="filter-btn" onclick="filterResults('etf')">ETF</button>
                <button class="filter-btn" onclick="filterResults('stock')">股票</button>
                <button class="filter-btn" onclick="filterResults('index')">指数</button>
            </div>
            <table class="results-table">
                <thead>
                    <tr>
                        <th onclick="sortTable(0)">标的 ↕</th>
                        <th onclick="sortTable(1)">总收益率 ↕</th>
                        <th onclick="sortTable(2)">年化收益率 ↕</th>
                        <th onclick="sortTable(3)">最大回撤 ↕</th>
                        <th onclick="sortTable(4)">夏普比率 ↕</th>
                        <th onclick="sortTable(5)">最终资产 ↕</th>
                        <th onclick="sortTable(6)">定投买入 ↕</th>
                        <th onclick="sortTable(7)">定投卖出 ↕</th>
                        <th onclick="sortTable(8)">做T买入 ↕</th>
                        <th onclick="sortTable(9)">做T卖出 ↕</th>
                        <th onclick="sortTable(10)">做T盈亏 ↕</th>
                        <th onclick="sortTable(11)">数据时间范围 ↕</th>
                        <th onclick="sortTable(12)">年度收益 ↕</th>
                    </tr>
                </thead>
                <tbody id="resultsTableBody">
                    <tr>
                        <td colspan="13" style="text-align: center;">加载中...</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
    
    <script>
        let currentSymbol = null;
        let klineChart = null;
        
        function filterSymbols() {
            const searchTerm = document.getElementById('symbolSearch').value.toLowerCase();
            const symbolItems = document.querySelectorAll('.symbol-item');
            
            symbolItems.forEach(item => {
                const code = item.dataset.symbol.toLowerCase();
                const name = item.dataset.name.toLowerCase();
                
                if (code.includes(searchTerm) || name.includes(searchTerm)) {
                    item.style.display = 'flex';
                } else {
                    item.style.display = 'none';
                }
            });
        }
        
        function selectSymbol(symbol) {
            currentSymbol = symbol;
            
            // 更新选中状态
            document.querySelectorAll('.symbol-item').forEach(item => {
                item.classList.remove('active');
                if (item.dataset.symbol === symbol) {
                    item.classList.add('active');
                }
            });
            
            // 加载数据
            loadChartData(symbol);
            loadIndicatorsData(symbol);
            loadTradesData(symbol);
            loadResults(symbol);
        }
        
        function runBacktest(symbol) {
            console.log('开始运行回测:', symbol);
            
            // 显示加载提示
            const chartContainer = document.getElementById('klineChart');
            if (chartContainer) {
                chartContainer.innerHTML = '<div style="display: flex; justify-content: center; align-items: center; height: 100%; color: #667eea;"><div>正在运行回测，请稍候...</div></div>';
            }
            
            fetch(`/api/backtest/${symbol}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                console.log('回测结果:', data);
                if (data.success) {
                    console.log('回测成功:', data.message);
                    // 回测完成后重新加载K线图数据，这样买卖点就能正确显示了
                    loadChartData(symbol);
                } else {
                    console.error('回测失败:', data.message);
                    alert('回测失败: ' + data.message);
                }
            })
            .catch(error => {
                console.error('回测请求失败:', error);
                alert('回测请求失败: ' + error.message);
            });
        }
        
        function loadChartData(symbol) {
            console.log('开始加载K线图数据:', symbol);
            fetch(`/api/chart/${symbol}`)
                .then(response => {
                    console.log('响应状态:', response.status);
                    return response.json();
                })
                .then(data => {
                    console.log('K线图数据加载成功:', data);
                    if (data.error) {
                        console.error('数据错误:', data.error);
                        alert(data.error);
                        return;
                    }
                    
                    renderKlineChart(data);
                })
                .catch(error => {
                    console.error('加载K线图数据失败:', error);
                    alert('加载K线图数据失败: ' + error.message);
                });
        }
        
        function renderKlineChart(data) {
            console.log('K线图数据:', data);
            console.log('数据长度:', data.length);
            
            if (!data || data.length === 0) {
                console.error('K线图数据为空');
                return;
            }
            
            const dates = data.map(item => item.date);
            const values = data.map(item => [item.open, item.close, item.low, item.high]);
            
            console.log('日期数量:', dates.length);
            console.log('K线数据数量:', values.length);
            console.log('第一个数据点:', data[0]);
            console.log('最后一个数据点:', data[data.length - 1]);
            
            const option = {
                title: {
                    text: `${currentSymbol} K线图`,
                    left: 'center',
                    textStyle: {
                        fontSize: 18,
                        color: '#333'
                    }
                },
                tooltip: {
                    trigger: 'axis',
                    axisPointer: {
                        type: 'cross'
                    }
                },
                legend: {
                    data: ['K线', 'MACD', 'MACD信号线'],
                    top: 30
                },
                grid: [
                    {
                        left: '10%',
                        right: '10%',
                        top: 60,
                        height: '50%',
                        containLabel: true
                    },
                    {
                        left: '10%',
                        right: '10%',
                        top: '70%',
                        height: '25%',
                        containLabel: true
                    }
                ],
                xAxis: [
                    {
                        type: 'category',
                        data: dates,
                        scale: true,
                        boundaryGap: [20, 20],
                        gridIndex: 0
                    },
                    {
                        type: 'category',
                        data: dates,
                        scale: true,
                        boundaryGap: [20, 20],
                        gridIndex: 1,
                        axisLabel: { show: false }
                    }
                ],
                yAxis: [
                    {
                        scale: true,
                        splitArea: {
                            show: true,
                            areaStyle: {
                                color: ['rgba(102,126,234,0.1)', 'rgba(102,126,234,0.1)']
                            }
                        },
                        gridIndex: 0
                    },
                    {
                        scale: true,
                        splitArea: {
                            show: true,
                            areaStyle: {
                                color: ['rgba(102,126,234,0.1)', 'rgba(102,126,234,0.1)']
                            }
                        },
                        gridIndex: 1
                    }
                ],
                dataZoom: [
                    {
                        type: 'inside',
                        xAxisIndex: [0, 1],
                        start: 50,
                        end: 100
                    },
                    {
                        xAxisIndex: [0, 1],
                        start: 50,
                        end: 100
                    }
                ],
                series: [
                    {
                        name: 'K线',
                        type: 'candlestick',
                        data: values,
                        itemStyle: {
                            color: '#10b981',
                            color0: '#ef4444',
                            borderColor: '#667eea',
                            borderColor0: '#667eea'
                        }
                    },
                    {
                        name: '买入点',
                        type: 'effectScatter',
                        xAxisIndex: 0,
                        yAxisIndex: 0,
                        data: [],
                        symbolSize: 10,
                        symbol: 'triangle',
                        symbolRotate: 180,
                        itemStyle: {
                            color: '#10b981'
                        },
                        label: {
                            show: true,
                            position: 'top',
                            formatter: 'buy',
                            color: '#10b981',
                            fontWeight: 'bold',
                            fontSize: 12
                        }
                    },
                    {
                        name: '卖出点',
                        type: 'effectScatter',
                        xAxisIndex: 0,
                        yAxisIndex: 0,
                        data: [],
                        symbolSize: 10,
                        symbol: 'triangle',
                        itemStyle: {
                            color: '#ef4444'
                        },
                        label: {
                            show: true,
                            position: 'bottom',
                            formatter: 'sell',
                            color: '#ef4444',
                            fontWeight: 'bold',
                            fontSize: 12
                        }
                    },
                    {
                        name: 'MACD',
                        type: 'line',
                        xAxisIndex: 1,
                        yAxisIndex: 1,
                        data: data.map(item => item.macd),
                        smooth: true,
                        lineStyle: {
                            color: '#667eea',
                            width: 2
                        }
                    },
                    {
                        name: 'MACD信号线',
                        type: 'line',
                        xAxisIndex: 1,
                        yAxisIndex: 1,
                        data: data.map(item => item.macd_signal),
                        smooth: true,
                        lineStyle: {
                            color: '#f59e0b',
                            width: 2
                        }
                    }
                ]
            };
            
            if (klineChart) {
                klineChart.dispose();
            }
            
            const chartContainer = document.getElementById('klineChart');
            console.log('图表容器尺寸:', {
                width: chartContainer.offsetWidth,
                height: chartContainer.offsetHeight
            });
            
            // 确保容器有正确的尺寸
            if (chartContainer.offsetWidth === 0 || chartContainer.offsetHeight === 0) {
                console.error('图表容器尺寸为0，延迟初始化');
                setTimeout(() => {
                    renderKlineChart(data);
                }, 100);
                return;
            }
            
            klineChart = echarts.init(chartContainer);
            klineChart.setOption(option);
            
            console.log('K线图渲染完成');
            
            // 响应式调整
            window.addEventListener('resize', function() {
                klineChart.resize();
            });
            
            // 尝试加载交易数据并添加买卖点
            loadTradesData(currentSymbol);
            
            // 更新最新指标值
            if (data.length > 0) {
                const latest = data[data.length - 1];
                console.log('最新数据:', latest);
                
                document.getElementById('currentPrice').textContent = latest.close ? latest.close.toFixed(2) : '--';
                document.getElementById('macdValue').textContent = latest.macd ? latest.macd.toFixed(4) : '--';
                document.getElementById('volumeRatio').textContent = latest.volume_ratio ? latest.volume_ratio.toFixed(2) : '--';
                document.getElementById('atrRatio').textContent = latest.atr_ratio ? (latest.atr_ratio * 100).toFixed(2) + '%' : '--';
                
                if (latest.is_overvalued) {
                    document.getElementById('valuationStatus').textContent = '高估';
                    document.getElementById('valuationStatus').style.color = '#ef4444';
                } else if (latest.is_undervalued) {
                    document.getElementById('valuationStatus').textContent = '低估';
                    document.getElementById('valuationStatus').style.color = '#10b981';
                } else {
                    document.getElementById('valuationStatus').textContent = '合理';
                    document.getElementById('valuationStatus').style.color = '#667eea';
                }
                
                if (latest.signal_add) {
                    document.getElementById('signalStatus').textContent = '加仓信号';
                    document.getElementById('signalStatus').style.color = '#10b981';
                } else if (latest.signal_reduce) {
                    document.getElementById('signalStatus').textContent = '减仓信号';
                    document.getElementById('signalStatus').style.color = '#ef4444';
                } else {
                    document.getElementById('signalStatus').textContent = '无信号';
                    document.getElementById('signalStatus').style.color = '#667eea';
                }
            }
        }
        
        function loadIndicatorsData(symbol) {
            fetch(`/api/indicators/${symbol}`)
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        console.error(data.error);
                        return;
                    }
                    // 指标数据已在K线图中显示
                })
                .catch(error => {
                    console.error('加载指标数据失败:', error);
                });
        }
        
        function loadTradesData(symbol) {
            fetch(`/api/trades/${symbol}`)
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        console.error(data.error);
                        return;
                    }
                    
                    console.log('交易数据:', data);
                    console.log('买入点数量:', data.buy_points.length);
                    console.log('卖出点数量:', data.sell_points.length);
                    
                    // 等待K线图渲染完成后再添加买卖点
                    const waitForChart = setInterval(() => {
                        if (klineChart) {
                            clearInterval(waitForChart);
                            // 在K线图上添加买卖点
                            addTradeMarkers(data.buy_points, data.sell_points);
                        }
                    }, 100);
                })
                .catch(error => {
                    console.error('加载交易数据失败:', error);
                });
        }
        
        function addTradeMarkers(buyPoints, sellPoints) {
            if (!klineChart) {
                console.error('K线图未初始化');
                return;
            }
            
            console.log('添加买卖点:', { buyPoints, sellPoints });
            
            const option = klineChart.getOption();
            
            // 更新买入点数据
            if (option.series[1]) {
                option.series[1].data = buyPoints;
                console.log('买入点已更新:', buyPoints.length);
            } else {
                console.error('买入点系列不存在');
            }
            
            // 更新卖出点数据
            if (option.series[2]) {
                option.series[2].data = sellPoints;
                console.log('卖出点已更新:', sellPoints.length);
            } else {
                console.error('卖出点系列不存在');
            }
            
            // 更新图表
            klineChart.setOption(option);
            console.log('图表已更新');
        }
        
        let allResults = [];
        let currentFilter = 'all';
        let sortDirection = {};
        
        function filterResults(type) {
            currentFilter = type;
            
            // 更新按钮状态
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.textContent === (type === 'all' ? '全部' : type === 'etf' ? 'ETF' : type === 'stock' ? '股票' : '指数')) {
                    btn.classList.add('active');
                }
            });
            
            // 过滤结果
            let filteredResults = allResults;
            if (type !== 'all') {
                filteredResults = allResults.filter(r => r.type === type);
            }
            
            displayAllResults(filteredResults);
        }
        
        function loadAllResults() {
            console.log('开始加载所有回测结果...');
            fetch('/api/summary')
                .then(response => {
                    console.log('API响应状态:', response.status);
                    return response.json();
                })
                .then(data => {
                    console.log('API返回的数据:', data);
                    console.log('数据类型:', typeof data);
                    console.log('数据长度:', data.length);
                    allResults = data;
                    displayAllResults(data);
                })
                .catch(error => {
                    console.error('加载所有结果失败:', error);
                });
        }
        
        function displayAllResults(results) {
            console.log('displayAllResults 被调用，results:', results);
            console.log('results 类型:', typeof results);
            console.log('results 长度:', results.length);
            
            const tbody = document.getElementById('resultsTableBody');
            
            if (!results || results.length === 0) {
                console.log('结果为空，显示暂无数据');
                tbody.innerHTML = '<tr><td colspan="13" style="text-align: center;">暂无数据</td></tr>';
                return;
            }
            
            console.log('开始渲染表格，数据条数:', results.length);
            
            const formatPercent = (value) => {
                const formatted = (value * 100).toFixed(2);
                return value >= 0 ? 
                    `<span class="positive">${formatted}%</span>` : 
                    `<span class="negative">${formatted}%</span>`;
            };
            
            const formatAnnualReturns = (annualReturns) => {
                // 如果是字符串，尝试解析为JSON
                let parsedReturns = annualReturns;
                if (typeof annualReturns === 'string') {
                    try {
                        // 直接解析JSON字符串
                        parsedReturns = JSON.parse(annualReturns);
                    } catch (e) {
                        console.error('解析年度收益失败:', e, annualReturns);
                        return '<small style="color: #999;">解析失败</small>';
                    }
                }
                
                if (!parsedReturns || parsedReturns.length === 0) {
                    return '<small style="color: #999;">无数据</small>';
                }
                return parsedReturns.map(ar => 
                    `<div style="font-size: 11px; margin-bottom: 2px;">
                        ${ar.year}年: ${ar.return >= 0 ? '<span class="positive">' : '<span class="negative">'}${(ar.return * 100).toFixed(2)}%</span> 
                        (¥${ar.profit.toLocaleString('zh-CN', {minimumFractionDigits: 0})})
                    </div>`
                ).join('');
            };
            
            // 类型标签样式
            const typeStyles = {
                'etf': { bg: '#10b981', text: '#fff' },
                'stock': { bg: '#667eea', text: '#fff' },
                'index': { bg: '#f59e0b', text: '#fff' }
            };
            
            const typeNames = {
                'etf': 'ETF',
                'stock': '股票',
                'index': '指数'
            };
            
            tbody.innerHTML = results.map(item => `
                <tr ondblclick="openSymbolDetail('${item.symbol}')" style="cursor: pointer;">
                    <td>
                        <span class="type-tag" style="background: ${typeStyles[item.type]?.bg || '#999'}; color: ${typeStyles[item.type]?.text || '#fff'};">
                            ${typeNames[item.type] || item.type}
                        </span>
                        <br>
                        <strong>${item.name}</strong>
                        <br><small style="color: #666;">${item.symbol}</small>
                    </td>
                    <td>${formatPercent(item.total_return)}</td>
                    <td>${formatPercent(item.annual_return)}</td>
                    <td>${formatPercent(item.max_drawdown)}</td>
                    <td>${item.sharpe_ratio.toFixed(2)}</td>
                    <td>¥${item.final_value.toLocaleString('zh-CN', {minimumFractionDigits: 2})}</td>
                    <td>${item.dca_buy_count}</td>
                    <td>${item.dca_sell_count}</td>
                    <td>${item.t_buy_count}</td>
                    <td>${item.t_sell_count}</td>
                    <td class="${item.t_profit >= 0 ? 'positive' : 'negative'}">¥${item.t_profit.toLocaleString('zh-CN', {minimumFractionDigits: 2})}</td>
                    <td><small style="color: #666;">${item.data_start_date || 'N/A'}<br>${item.data_end_date || 'N/A'}</small></td>
                    <td>${formatAnnualReturns(item.annual_returns)}</td>
                </tr>
            `).join('');
        }
        
        function openSymbolDetail(symbol) {
            window.location.href = `/symbol/${symbol}`;
        }
        
        function sortTable(columnIndex) {
            const keys = ['symbol', 'total_return', 'annual_return', 'max_drawdown', 
                         'sharpe_ratio', 'final_value', 'dca_buy_count', 'dca_sell_count',
                         't_buy_count', 't_sell_count', 't_profit', 'data_start_date', 'annual_returns'];
            const key = keys[columnIndex];
            
            sortDirection[key] = sortDirection[key] === 'asc' ? 'desc' : 'asc';
            
            // 先根据当前过滤器过滤结果
            let filteredResults = allResults;
            if (currentFilter !== 'all') {
                filteredResults = allResults.filter(r => r.type === currentFilter);
            }
            
            const sorted = [...filteredResults].sort((a, b) => {
                let valA = a[key];
                let valB = b[key];
                
                if (key === 'annual_returns') {
                    const totalReturnA = (valA || []).reduce((sum, ar) => sum + ar.return, 0);
                    const totalReturnB = (valB || []).reduce((sum, ar) => sum + ar.return, 0);
                    return sortDirection[key] === 'asc' ? totalReturnA - totalReturnB : totalReturnB - totalReturnA;
                }
                
                if (typeof valA === 'string') {
                    return sortDirection[key] === 'asc' ? 
                        valA.localeCompare(valB) : valB.localeCompare(valA);
                } else {
                    return sortDirection[key] === 'asc' ? valA - valB : valB - valA;
                }
            });
            
            displayAllResults(sorted);
        }
        
        function loadResults(symbol) {
            fetch(`/api/results/${symbol}`)
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        console.error(data.error);
                        return;
                    }
                    
                    displayResults(data);
                })
                .catch(error => {
                    console.error('加载结果失败:', error);
                });
        }
        
        function displayResults(results) {
            const tbody = document.getElementById('resultsTableBody');
            
            if (!results.summary) {
                tbody.innerHTML = '<tr><td colspan="11" style="text-align: center;">暂无数据</td></tr>';
                return;
            }
            
            const summary = results.summary;
            
            const formatPercent = (value) => {
                const formatted = (value * 100).toFixed(2);
                return value >= 0 ? 
                    `<span class="positive">${formatted}%</span>` : 
                    `<span class="negative">${formatted}%</span>`;
            };
            
            tbody.innerHTML = `
                <tr>
                    <td>${currentSymbol}</td>
                    <td>${formatPercent(summary.total_return)}</td>
                    <td>${formatPercent(summary.annual_return)}</td>
                    <td>${formatPercent(summary.max_drawdown)}</td>
                    <td>${summary.sharpe_ratio.toFixed(2)}</td>
                    <td>¥${summary.final_value.toLocaleString('zh-CN', {minimumFractionDigits: 2})}</td>
                    <td>${summary.dca_buy_count}</td>
                    <td>${summary.dca_sell_count}</td>
                    <td>${summary.t_buy_count}</td>
                    <td>${summary.t_sell_count}</td>
                    <td class="${summary.t_profit >= 0 ? 'positive' : 'negative'}">¥${summary.t_profit.toLocaleString('zh-CN', {minimumFractionDigits: 2})}</td>
                </tr>
            `;
        }
        
        let currentStrategy = null;
        
        function loadStrategies() {
            fetch('/api/strategies')
                .then(response => response.json())
                .then(strategies => {
                    const strategiesGrid = document.getElementById('strategiesGrid');
                    strategiesGrid.innerHTML = '';
                    
                    strategies.forEach(strategy => {
                        const card = document.createElement('div');
                        card.className = 'strategy-card';
                        card.dataset.strategyId = strategy.id;
                        card.innerHTML = `
                            <h3>${strategy.name}</h3>
                            <p>${strategy.description}</p>
                            <p class="version">版本: ${strategy.version}</p>
                        `;
                        card.onclick = () => selectStrategy(strategy.id);
                        strategiesGrid.appendChild(card);
                    });
                })
                .catch(error => {
                    console.error('加载策略列表失败:', error);
                });
        }
        
        function selectStrategy(strategyId) {
            currentStrategy = strategyId;
            
            fetch(`/api/strategy/${strategyId}`)
                .then(response => response.json())
                .then(strategyDetail => {
                    displayStrategyDetail(strategyDetail);
                })
                .catch(error => {
                    console.error('加载策略详情失败:', error);
                });
        }
        
        function displayStrategyDetail(strategyDetail) {
            const detailSection = document.getElementById('strategyDetailSection');
            const detailContent = document.getElementById('strategyDetailContent');
            
            let html = '';
            
            if (strategyDetail.params) {
                html += `
                    <div class="strategy-detail-item">
                        <h3>策略参数</h3>
                        <ul>
                            ${Object.entries(strategyDetail.params).map(([key, value]) => `<li>${key}: ${value}</li>`).join('')}
                        </ul>
                    </div>
                `;
            }
            
            if (strategyDetail.dca_logic) {
                html += `
                    <div class="strategy-detail-item">
                        <h3>定投逻辑</h3>
                        <p><strong>${strategyDetail.dca_logic.name}</strong>: ${strategyDetail.dca_logic.description}</p>
                        <ul>
                            <li><strong>买入条件</strong>: ${strategyDetail.dca_logic.buy_condition}</li>
                            <li><strong>卖出条件</strong>: ${strategyDetail.dca_logic.sell_condition}</li>
                            ${strategyDetail.dca_logic.sell_method ? `<li><strong>卖出方式</strong>: ${strategyDetail.dca_logic.sell_method}</li>` : ''}
                        </ul>
                    </div>
                `;
            }
            
            if (strategyDetail.t_logic) {
                html += `
                    <div class="strategy-detail-item">
                        <h3>做T逻辑</h3>
                        <p><strong>${strategyDetail.t_logic.name}</strong>: ${strategyDetail.t_logic.description}</p>
                        <ul>
                            ${strategyDetail.t_logic.conditions.map((condition, index) => `
                                <li>
                                    <strong>条件${index + 1}</strong>: ${condition.condition}<br>
                                    <strong>操作</strong>: ${condition.action}<br>
                                    <strong>退出</strong>: ${condition.exit}<br>
                                    <strong>止损</strong>: ${condition.stop_loss}
                                </li>
                            `).join('')}
                        </ul>
                    </div>
                `;
            }
            
            if (strategyDetail.logic) {
                html += `
                    <div class="strategy-detail-item">
                        <h3>策略逻辑</h3>
                        <p><strong>${strategyDetail.logic.name}</strong>: ${strategyDetail.logic.description}</p>
                        <ul>
                            <li><strong>买入条件</strong>: ${strategyDetail.logic.buy_condition}</li>
                            <li><strong>卖出条件</strong>: ${strategyDetail.logic.sell_condition}</li>
                        </ul>
                    </div>
                `;
            }
            
            detailContent.innerHTML = html;
            detailSection.classList.add('active');
            
            document.querySelectorAll('.strategy-card').forEach(card => {
                card.classList.remove('active');
                if (card.dataset.strategyId === strategyDetail.id) {
                    card.classList.add('active');
                }
            });
            
            loadAllResults();
        }
        
        window.onload = function() {
            loadStrategies();
            loadAllResults();
        };
    </script>
</body>
</html>