<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>标的详情 - {{ symbol }}</title>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background: #f5f7fa;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        .header h1 {
            margin: 0;
            font-size: 28px;
            font-weight: bold;
        }
        
        .header p {
            margin: 10px 0 0 0;
            font-size: 14px;
            opacity: 0.9;
        }
        
        .chart-section {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .chart-section h2 {
            margin: 0 0 15px 0;
            font-size: 18px;
            color: #667eea;
        }
        
        .chart-container {
            width: 100%;
            height: 800px;
        }
        
        .legend {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-top: 15px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
        }
        
        .legend-color {
            width: 16px;
            height: 16px;
            border-radius: 3px;
        }
        
        .back-button {
            display: inline-block;
            padding: 10px 20px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s;
            margin-bottom: 15px;
        }
        
        .back-button:hover {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        
        .strategy-selector {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .strategy-selector h2 {
            margin: 0 0 15px 0;
            font-size: 18px;
            color: #667eea;
        }
        
        .strategy-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .strategy-btn {
            padding: 10px 20px;
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }
        
        .strategy-btn:hover {
            background: #f0f4ff;
            border-color: #667eea;
        }
        
        .strategy-btn.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }
        
        .comparison-table {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .comparison-table h2 {
            margin: 0 0 15px 0;
            font-size: 18px;
            color: #667eea;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
        }
        
        th {
            background: #f8f9fa;
            padding: 12px;
            text-align: left;
            font-weight: 600;
            border-bottom: 2px solid #e9ecef;
        }
        
        td {
            padding: 12px;
            border-bottom: 1px solid #e9ecef;
        }
        
        tr:hover {
            background: #f8f9fa;
        }
        
        .positive {
            color: #10b981;
        }
        
        .negative {
            color: #ef4444;
        }
        
        .best {
            background: #d1fae5 !important;
            font-weight: 600;
        }
    </style>
</head>
<body>
    <div class="container">
        <button class="back-button" onclick="window.close()">关闭窗口</button>
        
        <div class="header">
            <h1>{{ symbol }} - {{ name }}</h1>
            <p>定投+做T策略回测详情</p>
        </div>
        
        <div class="strategy-selector">
            <h2>策略选择</h2>
            <div class="strategy-buttons" id="strategyButtons">
            </div>
        </div>
        
        <div class="chart-section">
            <h2>K线图与技术指标</h2>
            <div class="chart-container" id="klineChart"></div>
            <div class="legend">
                <div class="legend-item">
                    <div class="legend-color" style="background: #ef4444;"></div>
                    <span>卖出点</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #10b981;"></div>
                    <span>买入点</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #667eea;"></div>
                    <span>MACD</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #f59e0b;"></div>
                    <span>MACD信号线</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #ec4899;"></div>
                    <span>MA5</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #8b5cf6;"></div>
                    <span>MA10</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #06b6d4;"></div>
                    <span>MA20</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #ec4899;"></div>
                    <span>仓位(万元)</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #10b981;"></div>
                    <span>买入(万元)</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #ef4444;"></div>
                    <span>卖出(万元)</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #06b6d4;"></div>
                    <span>累计收益(万元)</span>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        const symbol = '{{ symbol }}';
        const name = '{{ name }}';
        let klineChart = null;
        let currentStrategy = 'dca_trading_v1';
        let strategiesData = [];
        
        function getStrategyFromUrl() {
            const urlParams = new URLSearchParams(window.location.search);
            const strategyParam = urlParams.get('strategy');
            if (strategyParam === 'dca_trading_v2') {
                return 'dca_trading_v2';
            } else if (strategyParam === 'dca_trading_v1') {
                return 'dca_trading_v1';
            } else if (strategyParam === 'dca_only') {
                return 'dca_only';
            }
            return 'dca_trading_v1';
        }
        
        function loadStrategiesData() {
            currentStrategy = getStrategyFromUrl();
            
            fetch(`/api/symbol/${symbol}/strategies`)
                .then(response => response.json())
                .then(data => {
                    strategiesData = data.strategies;
                    displayStrategyButtons();
                    
                    if (strategiesData.length > 0) {
                        loadChartData();
                    }
                })
                .catch(error => {
                    console.error('加载策略数据失败:', error);
                });
        }
        
        function displayStrategyButtons() {
            const container = document.getElementById('strategyButtons');
            container.innerHTML = '';
            
            strategiesData.forEach(strategy => {
                const btn = document.createElement('button');
                btn.className = 'strategy-btn';
                btn.textContent = strategy.strategy_name;
                btn.dataset.strategyId = strategy.strategy_id;
                btn.onclick = () => selectStrategy(strategy.strategy_id);
                if (strategy.strategy_id === currentStrategy) {
                    btn.classList.add('active');
                }
                container.appendChild(btn);
            });
        }
        
        function selectStrategy(strategyId) {
            currentStrategy = strategyId;
            
            document.querySelectorAll('.strategy-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.dataset.strategyId === strategyId) {
                    btn.classList.add('active');
                }
            });
            
            loadChartData();
        }
        
        function loadChartData() {
            let apiUrl = `/api/chart/${symbol}`;
            if (currentStrategy === 'dca_trading_v2') {
                apiUrl = `/api/chart/${symbol}?strategy=v2`;
            } else if (currentStrategy === 'dca_trading_v1') {
                apiUrl = `/api/chart/${symbol}?strategy=v1`;
            } else if (currentStrategy === 'dca_only') {
                apiUrl = `/api/chart/${symbol}?strategy=dca_only`;
            }
            
            fetch(apiUrl)
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        console.error(data.error);
                        return;
                    }
                    
                    displayChart(data);
                })
                .catch(error => {
                    console.error('加载图表数据失败:', error);
                });
        }
        
        function displayChart(data) {
            const chartDom = document.getElementById('klineChart');
            klineChart = echarts.init(chartDom);
            
            const dates = data.dates;
            const klineData = data.kline;
            const ma5Data = data.ma5 || [];
            const ma10Data = data.ma10 || [];
            const ma20Data = data.ma20 || [];
            const macdData = data.macd || [];
            const macdSignalData = data.macd_signal || [];
            const volumeData = data.volume || [];
            const buyPoints = data.buy_points || [];
            const sellPoints = data.sell_points || [];
            const positionData = data.position || [];
            const buyAmountData = data.buy_amount || [];
            const sellAmountData = data.sell_amount || [];
            const cumulativeReturnData = data.cumulative_return || [];
            
            const buyPointData = buyPoints.map(point => ({
                name: '买入',
                coord: [point.date, point.price],
                value: point.price,
                itemStyle: { color: '#10b981' }
            }));
            
            const sellPointData = sellPoints.map(point => ({
                name: '卖出',
                coord: [point.date, point.price],
                value: point.price,
                itemStyle: { color: '#ef4444' }
            }));
            
            const option = {
                title: {
                    text: `${symbol} - ${name}`,
                    left: 'center'
                },
                tooltip: {
                    trigger: 'axis',
                    axisPointer: {
                        type: 'cross'
                    },
                    formatter: function(params) {
                        let result = params[0].axisValue + '<br/>';
                        params.forEach(item => {
                            if (item.seriesName === '累计收益(万元)' && item.value !== null && item.value !== undefined) {
                                const profit = item.value >= 0 ? '+' : '';
                                result += `${item.marker} ${item.seriesName}: ${profit}${item.value.toFixed(4)} 万元<br/>`;
                            } else if (item.seriesName !== '累计收益(万元)' && item.value !== null && item.value !== undefined) {
                                result += `${item.marker} ${item.seriesName}: ${item.value}<br/>`;
                            }
                        });
                        return result;
                    }
                },
                legend: {
                    data: ['K线', 'MA5', 'MA10', 'MA20', 'MACD', 'MACD信号线', '成交量', '仓位(万元)', '买入(万元)', '卖出(万元)', '累计收益(万元)'],
                    top: 30
                },
                grid: [
                    {
                        left: '10%',
                        right: '8%',
                        height: '30%'
                    },
                    {
                        left: '10%',
                        right: '8%',
                        top: '35%',
                        height: '10%'
                    },
                    {
                        left: '10%',
                        right: '8%',
                        top: '48%',
                        height: '10%'
                    },
                    {
                        left: '10%',
                        right: '8%',
                        top: '61%',
                        height: '10%'
                    },
                    {
                        left: '10%',
                        right: '8%',
                        top: '74%',
                        height: '10%'
                    },
                    {
                        left: '10%',
                        right: '8%',
                        top: '87%',
                        height: '8%'
                    }
                ],
                xAxis: [
                    {
                        type: 'category',
                        data: dates,
                        scale: true,
                        boundaryGap: false,
                        axisLine: { onZero: false },
                        splitLine: { show: false },
                        min: 'dataMin',
                        max: 'dataMax'
                    },
                    {
                        type: 'category',
                        gridIndex: 1,
                        data: dates,
                        scale: true,
                        boundaryGap: false,
                        axisLine: { onZero: false },
                        axisTick: { show: false },
                        splitLine: { show: false },
                        axisLabel: { show: false },
                        min: 'dataMin',
                        max: 'dataMax'
                    },
                    {
                        type: 'category',
                        gridIndex: 2,
                        data: dates,
                        scale: true,
                        boundaryGap: false,
                        axisLine: { onZero: false },
                        axisTick: { show: false },
                        splitLine: { show: false },
                        axisLabel: { show: false },
                        min: 'dataMin',
                        max: 'dataMax'
                    },
                    {
                        type: 'category',
                        gridIndex: 3,
                        data: dates,
                        scale: true,
                        boundaryGap: false,
                        axisLine: { onZero: false },
                        axisTick: { show: false },
                        splitLine: { show: false },
                        axisLabel: { show: false },
                        min: 'dataMin',
                        max: 'dataMax'
                    },
                    {
                        type: 'category',
                        gridIndex: 4,
                        data: dates,
                        scale: true,
                        boundaryGap: false,
                        axisLine: { onZero: false },
                        axisTick: { show: false },
                        splitLine: { show: false },
                        axisLabel: { show: false },
                        min: 'dataMin',
                        max: 'dataMax'
                    },
                    {
                        type: 'category',
                        gridIndex: 5,
                        data: dates,
                        scale: true,
                        boundaryGap: false,
                        axisLine: { onZero: false },
                        axisTick: { show: false },
                        splitLine: { show: false },
                        axisLabel: { show: false },
                        min: 'dataMin',
                        max: 'dataMax'
                    }
                ],
                yAxis: [
                    {
                        scale: true,
                        splitArea: {
                            show: true
                        }
                    },
                    {
                        scale: true,
                        gridIndex: 1,
                        splitNumber: 2,
                        axisLabel: { show: false },
                        axisLine: { show: false },
                        splitLine: { show: false }
                    },
                    {
                        scale: true,
                        gridIndex: 2,
                        splitNumber: 2,
                        axisLabel: { show: false },
                        axisLine: { show: false },
                        splitLine: { show: false }
                    },
                    {
                        scale: true,
                        gridIndex: 3,
                        splitNumber: 2,
                        axisLabel: { show: false },
                        axisLine: { show: false },
                        splitLine: { show: false }
                    },
                    {
                        scale: true,
                        gridIndex: 4,
                        splitNumber: 2,
                        axisLabel: { show: false },
                        axisLine: { show: false },
                        splitLine: { show: false }
                    },
                    {
                        scale: true,
                        gridIndex: 5,
                        splitNumber: 2,
                        axisLabel: { show: false },
                        axisLine: { show: false },
                        splitLine: { show: false }
                    }
                ],
                dataZoom: [
                    {
                        type: 'inside',
                        xAxisIndex: [0, 1, 2, 3, 4, 5],
                        start: 50,
                        end: 100
                    },
                    {
                        show: true,
                        xAxisIndex: [0, 1, 2, 3, 4, 5],
                        type: 'slider',
                        top: '96%',
                        start: 50,
                        end: 100
                    }
                ],
                series: [
                    {
                        name: 'K线',
                        type: 'candlestick',
                        data: klineData,
                        itemStyle: {
                            color: '#ec0000',
                            color0: '#00da3c',
                            borderColor: '#8A0000',
                            borderColor0: '#008F28'
                        },
                        markPoint: {
                            data: [...buyPointData, ...sellPointData],
                            symbol: 'circle',
                            symbolSize: 8,
                            label: {
                                show: true,
                                position: 'top',
                                formatter: function(params) {
                                    return params.name;
                                }
                            }
                        }
                    },
                    {
                        name: 'MA5',
                        type: 'line',
                        data: ma5Data,
                        smooth: true,
                        lineStyle: {
                            opacity: 0.5
                        }
                    },
                    {
                        name: 'MA10',
                        type: 'line',
                        data: ma10Data,
                        smooth: true,
                        lineStyle: {
                            opacity: 0.5
                        }
                    },
                    {
                        name: 'MA20',
                        type: 'line',
                        data: ma20Data,
                        smooth: true,
                        lineStyle: {
                            opacity: 0.5
                        }
                    },
                    {
                        name: '成交量',
                        type: 'bar',
                        xAxisIndex: 1,
                        yAxisIndex: 1,
                        data: volumeData,
                        itemStyle: {
                            color: function(params) {
                                const klineItem = klineData[params.dataIndex];
                                if (klineItem) {
                                    return klineItem[1] > klineItem[0] ? '#ec0000' : '#00da3c';
                                }
                                return '#999';
                            }
                        }
                    },
                    {
                        name: 'MACD',
                        type: 'bar',
                        xAxisIndex: 2,
                        yAxisIndex: 2,
                        data: macdData,
                        itemStyle: {
                            color: function(params) {
                                return params.data >= 0 ? '#667eea' : '#f59e0b';
                            }
                        }
                    },
                    {
                        name: 'MACD信号线',
                        type: 'line',
                        xAxisIndex: 2,
                        yAxisIndex: 2,
                        data: macdSignalData,
                        lineStyle: {
                            color: '#f59e0b'
                        }
                    },
                    {
                        name: '仓位(万元)',
                        type: 'line',
                        xAxisIndex: 3,
                        yAxisIndex: 3,
                        data: positionData,
                        smooth: true,
                        lineStyle: {
                            color: '#ec4899'
                        }
                    },
                    {
                        name: '买入(万元)',
                        type: 'bar',
                        xAxisIndex: 4,
                        yAxisIndex: 4,
                        data: buyAmountData,
                        itemStyle: {
                            color: '#10b981'
                        }
                    },
                    {
                        name: '卖出(万元)',
                        type: 'bar',
                        xAxisIndex: 4,
                        yAxisIndex: 4,
                        data: sellAmountData,
                        itemStyle: {
                            color: '#ef4444'
                        }
                    },
                    {
                        name: '累计收益(万元)',
                        type: 'line',
                        xAxisIndex: 5,
                        yAxisIndex: 5,
                        data: cumulativeReturnData,
                        smooth: true,
                        lineStyle: {
                            color: '#06b6d4'
                        },
                        areaStyle: {
                            color: {
                                type: 'linear',
                                x: 0,
                                y: 0,
                                x2: 0,
                                y2: 1,
                                colorStops: [{
                                    offset: 0, color: 'rgba(6, 182, 212, 0.3)'
                                }, {
                                    offset: 1, color: 'rgba(6, 182, 212, 0.05)'
                                }]
                            }
                        }
                    }
                ]
            };
            
            klineChart.setOption(option);
            
            window.addEventListener('resize', function() {
                klineChart.resize();
            });
        }
        
        window.onload = function() {
            loadStrategiesData();
        };
    </script>
</body>
</html>